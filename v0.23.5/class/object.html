<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Basic object customization - PyO3 user guide</title>


        <!-- Custom HTML head -->

        <meta name="description" content="PyO3 user guide">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">PyO3 user guide</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/PyO3/pyo3/tree/main/guide" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/PyO3/pyo3/edit/main/guide/src/class/object.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="basic-object-customization"><a class="header" href="#basic-object-customization">Basic object customization</a></h1>
<p>Recall the <code>Number</code> class from the previous chapter:</p>
<pre><code class="language-rust"><span class="boring">#![allow(dead_code)]
</span>use pyo3::prelude::*;

#[pyclass]
struct Number(i32);

#[pymethods]
impl Number {
    #[new]
    fn new(value: i32) -&gt; Self {
        Self(value)
    }
}

#[pymodule]
fn my_module(m: &amp;Bound&lt;'_, PyModule&gt;) -&gt; PyResult&lt;()&gt; {
    m.add_class::&lt;Number&gt;()?;
    Ok(())
}</code></pre>
<p>At this point Python code can import the module, access the class and create class instances - but
nothing else.</p>
<pre><code class="language-python">from my_module import Number

n = Number(5)
print(n)
</code></pre>
<pre><code class="language-text">&lt;builtins.Number object at 0x000002B4D185D7D0&gt;
</code></pre>
<h3 id="string-representations"><a class="header" href="#string-representations">String representations</a></h3>
<p>It can't even print an user-readable representation of itself! We can fix that by defining the
<code>__repr__</code> and <code>__str__</code> methods inside a <code>#[pymethods]</code> block. We do this by accessing the value
contained inside <code>Number</code>.</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">
</span><span class="boring">#[pyclass]
</span><span class="boring">struct Number(i32);
</span><span class="boring">
</span>#[pymethods]
impl Number {
    // For `__repr__` we want to return a string that Python code could use to recreate
    // the `Number`, like `Number(5)` for example.
    fn __repr__(&amp;self) -&gt; String {
        // We use the `format!` macro to create a string. Its first argument is a
        // format string, followed by any number of parameters which replace the
        // `{}`'s in the format string.
        //
        //                       ðŸ‘‡ Tuple field access in Rust uses a dot
        format!("Number({})", self.0)
    }
    // `__str__` is generally used to create an "informal" representation, so we
    // just forward to `i32`'s `ToString` trait implementation to print a bare number.
    fn __str__(&amp;self) -&gt; String {
        self.0.to_string()
    }
}</code></pre>
<p>To automatically generate the <code>__str__</code> implementation using a <code>Display</code> trait implementation, pass the <code>str</code> argument to <code>pyclass</code>.</p>
<pre><code class="language-rust"><span class="boring">use std::fmt::{Display, Formatter};
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">
</span><span class="boring">#[allow(dead_code)]
</span><span class="boring">#[pyclass(str)]
</span><span class="boring">struct Coordinate {
</span>    x: i32,
    y: i32,
    z: i32,
}

impl Display for Coordinate {
    fn fmt(&amp;self, f: &amp;mut Formatter&lt;'_&gt;) -&gt; std::fmt::Result {
        write!(f, "({}, {}, {})", self.x, self.y, self.z)
    }
}</code></pre>
<p>For convenience, a shorthand format string can be passed to <code>str</code> as <code>str="&lt;format string&gt;"</code> for <strong>structs only</strong>.  It expands and is passed into the <code>format!</code> macro in the following ways:</p>
<ul>
<li><code>"{x}"</code> -&gt; <code>"{}", self.x</code></li>
<li><code>"{0}"</code> -&gt; <code>"{}", self.0</code></li>
<li><code>"{x:?}"</code> -&gt; <code>"{:?}", self.x</code></li>
</ul>
<p><em>Note: Depending upon the format string you use, this may require implementation of the <code>Display</code> or <code>Debug</code> traits for the given Rust types.</em><br />
<em>Note: the pyclass args <code>name</code> and <code>rename_all</code> are incompatible with the shorthand format string and will raise a compile time error.</em></p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">
</span><span class="boring">#[allow(dead_code)]
</span><span class="boring">#[pyclass(str="({x}, {y}, {z})")]
</span><span class="boring">struct Coordinate {
</span>    x: i32,
    y: i32,
    z: i32,
}</code></pre>
<h4 id="accessing-the-class-name"><a class="header" href="#accessing-the-class-name">Accessing the class name</a></h4>
<p>In the <code>__repr__</code>, we used a hard-coded class name. This is sometimes not ideal,
because if the class is subclassed in Python, we would like the repr to reflect
the subclass name. This is typically done in Python code by accessing
<code>self.__class__.__name__</code>. In order to be able to access the Python type information
<em>and</em> the Rust struct, we need to use a <code>Bound</code> as the <code>self</code> argument.</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::PyString;
</span><span class="boring">
</span><span class="boring">#[allow(dead_code)]
</span><span class="boring">#[pyclass]
</span><span class="boring">struct Number(i32);
</span><span class="boring">
</span>#[pymethods]
impl Number {
    fn __repr__(slf: &amp;Bound&lt;'_, Self&gt;) -&gt; PyResult&lt;String&gt; {
        // This is the equivalent of `self.__class__.__name__` in Python.
        let class_name: Bound&lt;'_, PyString&gt; = slf.get_type().qualname()?;
        // To access fields of the Rust struct, we need to borrow the `PyCell`.
        Ok(format!("{}({})", class_name, slf.borrow().0))
    }
}</code></pre>
<h3 id="hashing"><a class="header" href="#hashing">Hashing</a></h3>
<p>Let's also implement hashing. We'll just hash the <code>i32</code>. For that we need a <a href="https://doc.rust-lang.org/std/hash/trait.Hasher.html"><code>Hasher</code></a>. The one
provided by <code>std</code> is <a href="https://doc.rust-lang.org/std/collections/hash_map/struct.DefaultHasher.html"><code>DefaultHasher</code></a>, which uses the <a href="https://en.wikipedia.org/wiki/SipHash">SipHash</a> algorithm.</p>
<pre><code class="language-rust">use std::collections::hash_map::DefaultHasher;

// Required to call the `.hash` and `.finish` methods, which are defined on traits.
use std::hash::{Hash, Hasher};

<span class="boring">use pyo3::prelude::*;
</span><span class="boring">
</span><span class="boring">#[allow(dead_code)]
</span><span class="boring">#[pyclass]
</span><span class="boring">struct Number(i32);
</span><span class="boring">
</span>#[pymethods]
impl Number {
    fn __hash__(&amp;self) -&gt; u64 {
        let mut hasher = DefaultHasher::new();
        self.0.hash(&amp;mut hasher);
        hasher.finish()
    }
}</code></pre>
<p>To implement <code>__hash__</code> using the Rust <a href="https://doc.rust-lang.org/std/hash/trait.Hash.html"><code>Hash</code></a> trait implementation, the <code>hash</code> option can be used.
This option is only available for <code>frozen</code> classes to prevent accidental hash changes from mutating the object. If you need
an <code>__hash__</code> implementation for a mutable class, use the manual method from above. This option also requires <code>eq</code>: According to the
<a href="https://docs.python.org/3/reference/datamodel.html#object.__hash__">Python docs</a> "If a class does not define an <code>__eq__()</code>
method it should not define a <code>__hash__()</code> operation either"</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">
</span><span class="boring">#[allow(dead_code)]
</span>#[pyclass(frozen, eq, hash)]
#[derive(PartialEq, Hash)]
struct Number(i32);</code></pre>
<blockquote>
<p><strong>Note</strong>: When implementing <code>__hash__</code> and comparisons, it is important that the following property holds:</p>
<pre><code class="language-text">k1 == k2 -&gt; hash(k1) == hash(k2)
</code></pre>
<p>In other words, if two keys are equal, their hashes must also be equal. In addition you must take
care that your classes' hash doesn't change during its lifetime. In this tutorial we do that by not
letting Python code change our <code>Number</code> class. In other words, it is immutable.</p>
<p>By default, all <code>#[pyclass]</code> types have a default hash implementation from Python.
Types which should not be hashable can override this by setting <code>__hash__</code> to None.
This is the same mechanism as for a pure-Python class. This is done like so:</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span>#[pyclass]
struct NotHashable {}

#[pymethods]
impl NotHashable {
    #[classattr]
    const __hash__: Option&lt;Py&lt;PyAny&gt;&gt; = None;
}</code></pre>
</blockquote>
<h3 id="comparisons"><a class="header" href="#comparisons">Comparisons</a></h3>
<p>PyO3 supports the usual magic comparison methods available in Python such as <code>__eq__</code>, <code>__lt__</code>
and so on. It is also possible to support all six operations at once with <code>__richcmp__</code>.
This method will be called with a value of <code>CompareOp</code> depending on the operation.</p>
<pre><code class="language-rust">use pyo3::class::basic::CompareOp;

<span class="boring">use pyo3::prelude::*;
</span><span class="boring">
</span><span class="boring">#[allow(dead_code)]
</span><span class="boring">#[pyclass]
</span><span class="boring">struct Number(i32);
</span><span class="boring">
</span>#[pymethods]
impl Number {
    fn __richcmp__(&amp;self, other: &amp;Self, op: CompareOp) -&gt; PyResult&lt;bool&gt; {
        match op {
            CompareOp::Lt =&gt; Ok(self.0 &lt; other.0),
            CompareOp::Le =&gt; Ok(self.0 &lt;= other.0),
            CompareOp::Eq =&gt; Ok(self.0 == other.0),
            CompareOp::Ne =&gt; Ok(self.0 != other.0),
            CompareOp::Gt =&gt; Ok(self.0 &gt; other.0),
            CompareOp::Ge =&gt; Ok(self.0 &gt;= other.0),
        }
    }
}</code></pre>
<p>If you obtain the result by comparing two Rust values, as in this example, you
can take a shortcut using <code>CompareOp::matches</code>:</p>
<pre><code class="language-rust">use pyo3::class::basic::CompareOp;

<span class="boring">use pyo3::prelude::*;
</span><span class="boring">
</span><span class="boring">#[allow(dead_code)]
</span><span class="boring">#[pyclass]
</span><span class="boring">struct Number(i32);
</span><span class="boring">
</span>#[pymethods]
impl Number {
    fn __richcmp__(&amp;self, other: &amp;Self, op: CompareOp) -&gt; bool {
        op.matches(self.0.cmp(&amp;other.0))
    }
}</code></pre>
<p>It checks that the <code>std::cmp::Ordering</code> obtained from Rust's <code>Ord</code> matches
the given <code>CompareOp</code>.</p>
<p>Alternatively, you can implement just equality using <code>__eq__</code>:</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">
</span><span class="boring">#[pyclass]
</span><span class="boring">struct Number(i32);
</span><span class="boring">
</span>#[pymethods]
impl Number {
    fn __eq__(&amp;self, other: &amp;Self) -&gt; bool {
        self.0 == other.0
    }
}

<span class="boring">fn main() -&gt; PyResult&lt;()&gt; {
</span><span class="boring">    Python::with_gil(|py| {
</span><span class="boring">        let x = &amp;Bound::new(py, Number(4))?;
</span><span class="boring">        let y = &amp;Bound::new(py, Number(4))?;
</span><span class="boring">        assert!(x.eq(y)?);
</span><span class="boring">        assert!(!x.ne(y)?);
</span><span class="boring">        Ok(())
</span><span class="boring">    })
</span><span class="boring">}</span></code></pre>
<p>To implement <code>__eq__</code> using the Rust <a href="https://doc.rust-lang.org/stable/std/cmp/trait.PartialEq.html"><code>PartialEq</code></a> trait implementation, the <code>eq</code> option can be used.</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">
</span><span class="boring">#[allow(dead_code)]
</span>#[pyclass(eq)]
#[derive(PartialEq)]
struct Number(i32);</code></pre>
<p>To implement <code>__lt__</code>, <code>__le__</code>, <code>__gt__</code>, &amp; <code>__ge__</code> using the Rust <code>PartialOrd</code> trait implementation, the <code>ord</code> option can be used. <em>Note: Requires <code>eq</code>.</em></p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">
</span><span class="boring">#[allow(dead_code)]
</span>#[pyclass(eq, ord)]
#[derive(PartialEq, PartialOrd)]
struct Number(i32);</code></pre>
<h3 id="truthyness"><a class="header" href="#truthyness">Truthyness</a></h3>
<p>We'll consider <code>Number</code> to be <code>True</code> if it is nonzero:</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">
</span><span class="boring">#[allow(dead_code)]
</span><span class="boring">#[pyclass]
</span><span class="boring">struct Number(i32);
</span><span class="boring">
</span>#[pymethods]
impl Number {
    fn __bool__(&amp;self) -&gt; bool {
        self.0 != 0
    }
}</code></pre>
<h3 id="final-code"><a class="header" href="#final-code">Final code</a></h3>
<pre><code class="language-rust">use std::collections::hash_map::DefaultHasher;
use std::hash::{Hash, Hasher};

use pyo3::prelude::*;
use pyo3::class::basic::CompareOp;
use pyo3::types::PyString;

#[pyclass]
struct Number(i32);

#[pymethods]
impl Number {
    #[new]
    fn new(value: i32) -&gt; Self {
        Self(value)
    }

    fn __repr__(slf: &amp;Bound&lt;'_, Self&gt;) -&gt; PyResult&lt;String&gt; {
        let class_name: Bound&lt;'_, PyString&gt; = slf.get_type().qualname()?;
        Ok(format!("{}({})", class_name, slf.borrow().0))
    }

    fn __str__(&amp;self) -&gt; String {
        self.0.to_string()
    }

    fn __hash__(&amp;self) -&gt; u64 {
        let mut hasher = DefaultHasher::new();
        self.0.hash(&amp;mut hasher);
        hasher.finish()
    }

    fn __richcmp__(&amp;self, other: &amp;Self, op: CompareOp) -&gt; PyResult&lt;bool&gt; {
        match op {
            CompareOp::Lt =&gt; Ok(self.0 &lt; other.0),
            CompareOp::Le =&gt; Ok(self.0 &lt;= other.0),
            CompareOp::Eq =&gt; Ok(self.0 == other.0),
            CompareOp::Ne =&gt; Ok(self.0 != other.0),
            CompareOp::Gt =&gt; Ok(self.0 &gt; other.0),
            CompareOp::Ge =&gt; Ok(self.0 &gt;= other.0),
        }
    }

    fn __bool__(&amp;self) -&gt; bool {
        self.0 != 0
    }
}

#[pymodule]
fn my_module(m: &amp;Bound&lt;'_, PyModule&gt;) -&gt; PyResult&lt;()&gt; {
    m.add_class::&lt;Number&gt;()?;
    Ok(())
}</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../class/protocols.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../class/numeric.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../class/protocols.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../class/numeric.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
